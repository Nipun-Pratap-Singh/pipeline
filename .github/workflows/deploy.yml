name: Deploy to EC2

on:
  push:
    branches:
      - testing

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout the code from GitHub
      - name: Checkout code
        uses: actions/checkout@v3

      # Step 2: Merge staging into testing before deploying
      - name: Merge staging into testing
        run: |
          git fetch origin
          git checkout testing
          git merge --no-ff origin/staging -m "Merging staging into testing"
          git push origin testing

      # Step 3: Set up SSH and configure private key to connect to EC2
      - name: Setup SSH Connection
        run: |
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > private_key.pem
          chmod 600 private_key.pem  # Secure the key

      # Step 4: SSH into EC2 and deploy the updated code
      - name: Deploy to EC2
        run: |
          ssh -o StrictHostKeyChecking=no -i private_key.pem ubuntu@${{ secrets.EC2_PUBLIC_IP }} << 'EOF'
            set -e  # Exit on error
            echo "🔄 Pulling latest code..."
            cd ~/AgriHealthAnalyzer || { echo "Repository not found, cloning..."; git clone https://github.com/Nipun-Pratap-Singh/pipeline.git && cd pipeline; }
            git reset --hard
            git pull origin testing

            echo "🛠 Installing frontend dependencies & building..."
            cd ~/pipeline/client
            npm install
            npm run build  # Build frontend (Vite React)
            sudo rm -rf /var/www/html/*
            sudo cp -r ~/pipeline/client/dist/* /var/www/html/
            sudo systemctl restart nginx

            echo "⚙️ Restarting backend..."
            cd ~/pipeline/server
            npm install
            pm2 restart backend || pm2 start server.js --name backend
            pm2 save
          EOF

      # Step 5: Clean up private key
      - name: Clean up private key
        run: rm -f private_key.pem
